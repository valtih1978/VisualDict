<!--TODO: 

1. show/hide on hover. The must be a hover option to 
make object visible/hidden. Hidden objects disappear when we 
recede the mouse too far away.
2. List of words for search.

-->
<body onLoad='startRealtime()'>
  <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>
  <script src="libs/vis.js"></script>
  <script type="text/javascript" src="realtime-client-utils.js"></script>
  <script type="text/javascript" src="controller.js"></script>

<div id="network_div" style=""></div>

  <a class="controls" href="http://almende.github.io/vis/examples/network/21_data_manipulation.html">Almende</a>  
  <button class="controls" id="authorizeButton" disabled>You must authorize</button>
  <button class="controls" id="pickButton" onclick="pick()">Pick another file</button>
  <!-- Undo and redo buttons. -->
  <button class="controls" id="undoButton" disabled>Undo</button>
  <button class="controls" id="redoButton" disabled>Redo</button>
  <button class="controls" onclick="deleteButtonClicked()">Delete Selected</button>
  <button class="controls" id="rename_button" onclick="renameButtonClicked()" disabled>Rename</button>
  <button class="controls" onclick="addnodeButtonClicked()">add node</button>
  <button class="controls" id="connect_button" onclick="connectButtonClicked([])" disabled>connect</button>
  <button class="controls" id="disconnect_button" onclick="disconnectButtonClicked()" disabled>break</button>
  <input class="controls" id="input1"/>
  <span class="controls" id="ConnectMode_span" style="display:none">connect mode</span>
	<style type="text/css">
	body {font-family:verdana}
	.network-manipulationLabel {display: none}
	.controls {
		left: 0; top: 0;
		position: relative; 
		margin: 0;
		padding: 0;
	}
	#network_div {
		left: 0; top: 0;
		position: absolute;

		margin: 0;
		padding: 0;
		width: 100%;
		height: 100%;
	}
	</style>


  <!--
  <script src="http://almende.github.io/vis/dist/vis.js"></script>
  -->
<script>
	//
	
	["keydown", "keyup"].map(function(evt) {
		window.addEventListener(evt, function(event) {
			// Bind to both command (for Mac) and control (for Win/Linux)
			if ((event.keyCode == 17)) {
				var down = event.type == 'keydown'
				var newDisplay = down ? 'block' : 'none'
				if (ConnectMode_span.style.display != newDisplay) {
					ConnectMode_span.style.display = newDisplay
					var element = down ? 'addEdgeSpan' : 'backSpan'
					if (network.manipulationDOM[element])
						network.manipulationDOM[element].onclick()
					else
						console.log('element ' + element + " undefined")
					//console.log(element + ' = ' + (func ? 'defined' : 'undefined') + ", constants = " + ValUtils.dictToStr(network.constants.locales)) 
					//var func = network[down ? '_createAddEdgeToolbar' : '_createManipulatorBar']
					//console.log(down + ' = ' + (func ? 'defined' : 'undefined') + ", constants = " + ValUtils.dictToStr(network.constants.locales)) 
				}
				
			}
		}, true);
	})
	

	var options = {
		dataManipulation: {enabled: true, initiallyVisible:false},
		onConnect: function (edge, callback) {
			console.log('onUpdate ' + JSON.stringify(edge))
			controller.connect(edge.from, edge.to)
			callback([]); // cancel update. Do it with model update
		}
	};

	function control(func) {
		controller[func](input1.value)
	}
	
	function deleteButtonClicked() {
		// fired when user (rather than graph) initiates removal
		// Do the same as when graph initiates removal
		options.onDelete(network.getSelection() , function() {})
	}
	
	//fired when graph (rather than user) initiates removal. 
	// Promote the command to the model. Actualy graph will be
	// pruned on model update event.
	options.onDelete = function(deleted, cb) {
		controller.compound(function() {
			for (var key in deleted.nodes) {
				controller.deleteNode(deleted.nodes[key])
			}
			for (var key in deleted.edges) {
				var e = deleted.edges[key].split(controller.separator)
				console.log('have to delete ' + deleted.edges[key] + " also ")
				controller.disconnectNodes(e[0], e[1])
			}
			return cb([]) // cancel delete -- do in on model update
		})
	}

	// create an array with nodes
	nodes = new vis.DataSet();
	edges = new vis.DataSet();
  // create a network
	  //var container = document.getElementById('mynetwork');
	var network = new vis.Network(
		network_div, {nodes: nodes, edges: edges}, options);
	network.editMode = true // https://github.com/almende/vis/issues/605#issue-55793606
	network._createManipulatorBar()
	network.on('select', function(params) {
		console.log("params.nodes: " + params.nodes.join(',') + ", network.sel.nodes: " + network.getSelection().nodes.join(','))
		rename_button.disabled = (params.nodes.length != 1)
		connect_button.disabled = (params.nodes.length < 2)
		disconnect_button.disabled = (params.nodes.length < 1)
	})
	
	function renameButtonClicked() {
		var selected = network.getSelection().nodes
		//nodes.update({id: selected[0], label:validName})
		controller.renameNode(selected[0], input1.value)
	}
	
	function visAdd(validName) {
		var added = nodes.add({id: validName, label:validName})
	}
	
	//var edgeId = 100
	//function visConnect(nodeA, nodeB) {
		//edges.add({id: "e" + edgeId++, from: nodeA, to: nodeB}) //}
	
	function visConnect(nodeA, nodeB) {
		//edges.add({id: "e" + edgeId++, from: ids[i-1], to: ids[i]})
		console.log('connecting ' + nodeA + "-" + nodeB)
		if (validEdgeDir(nodeA, nodeB)) 
			edges.add({id: edgeId(nodeA, nodeB), from: nodeA, to: nodeB})
	}

	function addnodeButtonClicked() {
		var connectTo = network.getSelection().nodes
		controller.compound(function() {
			willingToSelect = controller.createNode(input1.value)
			for (var key in connectTo)
				controller.connect(connectTo[key], input1.value)
		})
	}
	function connectButtonClicked(plusAdded) {
		var ids = network.getSelection().nodes.concat(plusAdded)
		console.log("joining = " + ids.join(','))
		
		/*for (var i = 1 ; i != ids.length ; i++)
			visConnect(ids[i-1], ids[i])
		if (ids.length > 2) visConnect(ids[ids.length-1], ids[0])*/
		controller.compound(function() {
			for (var i = 1 ; i != ids.length ; i++)
				controller.connect(ids[i-1], ids[i])
			if (ids.length > 2) controller.connect(ids[ids.length-1], ids[0])
		})
	}
	
	function disconnectButtonClicked() {
		var ids = network.getSelection().edges
		var nodes = network.getSelection().nodes
		for (var i in nodes) for (var j in nodes) {
			var edge = edgeId(nodes[i], nodes[j])
			if (edges.get(edge) != null && validEdgeDir(nodes[i], nodes[j]))
				ids.push(edge)
		}
		//console.log("breaking " + ids.join('|'))
		options.onDelete({edges:ids} , function() {})
	}

	// called by controller.js
	function onMapValueChanged(evt) {
		if (evt.newValue == null) {
			//console.log("remote event: deleted " + evt.property)
			nodes.remove(evt.property)
		}
		else if (evt.oldValue == null) {
			//console.log("remote event: created " + evt.property)
			var added = visAdd(evt.property)
			if (willingToSelect == evt.property) network.selectNodes([willingToSelect])
			//connectButtonClicked([added])
		}
			
		else {
			//console.log("remote event: model updated " +  evt.property + ": " + evt.oldValue + " => " + evt.newValue)
			var src = evt.property
			var listWas = evt.oldValue.split(controller.separator)
			var newList = evt.newValue.split(controller.separator)
			newList.map(function(n) {
				if (listWas.indexOf(n) == -1) {
					console.log('connected a: ' + src + "-" + n)
					visConnect(src, n)
				}
			})
			listWas.map(function(w) {
				if (newList.indexOf(w) == -1) {
					console.log('disconnected ' + src + "-" + w)
					edges.remove(edgeId(src, w))
				}
			});
		}
		
	}
	/*
	function printAll() { 
		var keys = controller.graph.keys()
		for (i in keys) {
			console.log(keys[i] + " => " + controller.graph.get(keys[i]))
		}
	}*/

	function validEdgeDir(a, b) { return a < b }
	
	function edgeId(a,b) {
		return (validEdgeDir(a,b) ? [a,b] : [b,a]).join(controller.separator)
	}
	
	function onFileLoaded() { 
		var keys = controller.graph.keys()
		//cy.startBatch() try {
		for (var i in keys) {
			var key = keys[i]
			visAdd(key)
			var associations = controller.listConnections(key)
			for (var j in associations)
				visConnect(key, associations[j])
		}
	}	
    </script>

</body>